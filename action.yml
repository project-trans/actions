name: 'pr preview action'
description: 'Generate and post a preview URL as a PR comment.'
branding:
  icon: 'award'
  color: 'green'

inputs:
  previewUrl:
    required: true
  BOT_APP_ID:
    required: true
  BOT_APP_SECRET:
    required: true
  GITHUB_TOKEN:
    required: true
  REMOVE_PREFIX:
    required: false
  REMOVE_SUFFIX:
    required: false

runs:
  using: "composite"
  steps:
    - name: ä½¿ç”¨ GitHub App è¿›è¡Œèº«ä»½éªŒè¯
      id: auth
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ inputs.BOT_APP_ID }}
        private-key: ${{ inputs.BOT_APP_SECRET }}
        owner: ${{ github.repository_owner }}
      
    - name: List PR files using GitHub CLI
      id: url
      run: |
          # ä½¿ç”¨ GitHub CLI è·å– PR æ–‡ä»¶åˆ—è¡¨å¹¶æå–æ–‡ä»¶è·¯å¾„
          files=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            | jq -r '.[].filename')  # ä½¿ç”¨ -r è·å–åŸå§‹æ–‡æœ¬è¾“å‡º

          # å¤„ç†æ–‡ä»¶è·¯å¾„ï¼Œæ‹¼æ¥æˆå®Œæ•´çš„ URL
          for file in $files; do
            if [[ $file == *.md ]]; then
              # å»æ‰è·¯å¾„å‰ç¼€å’Œåç¼€
              modified_file="${file#${{ inputs.REMOVE_PREFIX }}}"   # åˆ é™¤è·¯å¾„å‰ç¼€
              modified_file="${modified_file%${{ inputs.REMOVE_SUFFIX }}}"  # åˆ é™¤è·¯å¾„åç¼€

              # æ‹¼æ¥ URL
              file_url="${{ inputs.previewUrl }}${modified_file}"
              all_file_urls="${all_file_urls}\n${file_url}"
            fi
          done
          echo "all_file_urls=${all_file_urls}" >> $GITHUB_ENV
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.GITHUB_TOKEN }}

    # è·å–é¢„è§ˆé“¾æ¥å¹¶å‘é€åˆ° PR
    - name: å‘é€æ•´ä½“ PR review
      uses: actions/github-script@v6
      with:
        github-token: ${{ steps.auth.outputs.token }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const reviewBody = `ğŸš€ é¢„è§ˆéƒ¨ç½²å®Œæˆï¼è®¿é—®é“¾æ¥: ${{ inputs.previewUrl }}\n\nâœ¨ æœ¬ PR ä¿®æ”¹äº†ä»¥ä¸‹é¡µé¢: âœ¨${{ env.all_file_urls }}`;

          // è·å–ç°æœ‰ review
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
          });

          // æŸ¥æ‰¾å·²æœ‰çš„è¯„è®º review
          const existingReview = reviews.find(review =>
            review.body.includes('ğŸš€ é¢„è§ˆéƒ¨ç½²å®Œæˆï¼'));

          if (existingReview) {
            // å¦‚æœå·²ç»æœ‰ reviewï¼Œæ›´æ–°å®ƒ
            await github.rest.pulls.updateReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              review_id: existingReview.id,
              body: reviewBody,
            });
          } else {
            // å¦‚æœæ²¡æœ‰ reviewï¼Œåˆ›å»ºæ–°çš„ review
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: reviewBody,
              event: "COMMENT",
            });
          }
